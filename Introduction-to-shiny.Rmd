---
title: "Introduction to Shiny"
author: "George & Wush"
date: '`r Sys.Date()`'
output:
  ioslides_presentation:
    css: css/dsp.css
    # logo: assets/img/Taiwan-R-logo.png
    widescreen: yes
subtitle: shiny
runtime: shiny
---

```{r setup, include = FALSE}
library(knitr)
library(shiny)
library(rmarkdown)
library(ggvis)
```

# 傢俬準備好

<img src="img/dsp-page.png" style="display:none"/>
<img src="img/dsp-front-cover.png" style="display:none"/>

## 環境安裝 {.flexbox .vcenter}

R 套件安裝
```{r Surround, eval=FALSE}
install.packages(c("dplyr","ggplot2","shiny","devtools"))
devtools::install_github('rstudio/shinyapps')
```
```{r echo=FALSE,eval=FALSE}
sessionInfo()
```

# shiny shiny little star

## 甚麼是shiny ? {.flexbox .vcenter}

<div class="columns-2">
- 一個基於R 語言的網頁應用框架
    - 可以用R 快速製作網頁應用
    - 利用近代網頁技術製作動態網頁
    - 分析結果「會動了」
- 由 RStudio 於 2012-11 年正式提出Beta版
- 目前於 2015-05 釋出 v0.11
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>

```{r shiny-example, echo = FALSE}
inputPanel(
  selectInput("n_breaks", label = "Number of bins:",
              choices = c(10, 20, 35, 50), selected = 20)
)

renderPlot({
  hist(faithful$eruptions, probability = TRUE, breaks = as.numeric(input$n_breaks),
       xlab = "Duration (minutes)", main = "Geyser eruption duration")
  
  dens <- density(faithful$eruptions, adjust = 1)
  lines(dens, col = "blue")
})
```

</div>

## 學Shiny的好處是？


<div class="columns-2">
- 目前在R 中，建立互動式分析報表最簡單的工具
    - 需要理解網頁應用的運作原理
    - **不需要**理解撰寫網頁應用的工具（HTML、CSS和Javascript）
        - 但是若想要擴充Shiny，則需要會這些工具
    - **不需要**改寫已經用R 撰寫的分析流程
        - 但是若希望能提供流暢的使用者體驗，則需要適度的優化
- 可以和現代的Javascript視覺化函式庫做整合
    - [Introducing ggvis](http://blog.rstudio.org/2014/06/23/introducing-ggvis/)
    - [htmlwidgets: JavaScript data visualization for R](http://blog.rstudio.org/2014/12/18/htmlwidgets-javascript-data-visualization-for-r/)

```{r ggvis-example, echo = FALSE}
bootstrapPage(
  ggvisOutput("p"),
  uiOutput("p_ui")
)

mtcars %>%
  ggvis(~wt, ~mpg) %>%
  layer_points() %>%
  layer_smooths(span = input_slider(0, 1)) %>%
  bind_shiny("p", "p_ui")
```
</div>

## 網頁應用的運作原理 {.flexbox .vcenter}

- 客戶端：
    - 瀏覽器進行畫面的呈現
    - 瀏覽器和使用者進行互動
        - 依據互動的過程，瀏覽器隨時會和伺服器交換資料
            - 瀏覽器發出*Request*
            - 伺服器回傳*Response*
- 伺服器端：
    - 伺服器提供畫面的規格給瀏覽器
    - 伺服器再依據瀏覽器提供的資訊，回傳使用者需要的資料

## Shiny的運作原理

- 基本架構  
    - `ui.R`: 客戶端，負責前端使用者介面的呈現 
    - `server.R`: 伺服器端，負責後端資料處理與計算
    - `global.R(optional)`: 放置ui與server共用的設定(`source`、`data`)

<div class="columns-2">
  ![Image](img/interactive-1.png)

  ![Image](img/interactive-2.png)
</div>

## Shiny - 客戶端輸入：`ui.R`

- shiny 會將 `ui.R`的R 物件轉換為HTML、CSS和Javascript，透過瀏覽器呈現
- 透過Javascript，瀏覽器會將使用者的動作轉換為Request發回給Server

```{r ui1, echo=TRUE}
inputPanel(
  selectInput("n_breaks", label = "Number of bins:",
              choices = c(10, 20, 35, 50), selected = 20)
)
```

```{r ui2, engine='R', results='markup', echo=FALSE}
print(inputPanel(
  selectInput("n_breaks", label = "Number of bins:",
              choices = c(10, 20, 35, 50), selected = 20)
))
```

## Shiny - 伺服器端：`server.R`

- Shiny server處理瀏覽器傳來的Request，轉化為R 中的`input`
- 我們撰寫R 函數將`input`轉換為`output`
- Shiny server再把`output`轉換為`Response`傳回瀏覽器

```{r server-demo, echo = TRUE, eval = FALSE}
function(input, output) {
  output$plot <- renderPlot({
    hist(faithful$eruptions, probability = TRUE, breaks = as.numeric(input$n_breaks),
         xlab = "Duration (minutes)", main = "Geyser eruption duration")
    
    dens <- density(faithful$eruptions, adjust = 1)
    lines(dens, col = "blue")
  })
}
```

## Shiny - 客戶端輸出：`ui.R`

- 透過Javascript，瀏覽器會將Server回傳的`Response`呈現在瀏覽器上

```{r ui3, echo = TRUE, eval = TRUE, results='markup'}
print(plotOutput("plot"))
```

```{r s2, echo = FALSE}
inputPanel(
  selectInput("n_breaks2", label = "Number of bins:",
              choices = c(10, 20, 35, 50), selected = 20)
)

renderPlot({
  hist(faithful$eruptions, probability = TRUE, breaks = as.numeric(input$n_breaks2),
       xlab = "Duration (minutes)", main = "Geyser eruption duration")
  
  dens <- density(faithful$eruptions, adjust = 1)
  lines(dens, col = "blue")
})
```


## `ui.R`  

<div class="columns-2">
  ![Image](img/ui.R-1.png)

  ![Image](img/ui.R-2.png)
</div>

## `server.R`

- Environment Variable  
    - 最外層 Run once: 讀套件、data  
- `shinyServer()`
    - 第一層 Function(), Run once per user
        - input list, output list, session
    - 第二層 Render Function, Run often
        - 建立輸出元件

# I want learn more

## Layout

通常指網頁版面，頁面的形式，佈局

- Sidebar Layouts(Simple default layout)
- Grid Layouts  
    - Custom application layouts: fluid & fixed
    - `fluidPage(fluidRow(column()))`
        - a flexibly sub-dividable 12-column grid for layout
- Segmenting Layouts
    - `navbarPage(tabPanel(), navbarMenu())`
    - `tabsetPanel(tabPanel()), navlistPanel(tabPanel())`
- Responsive Layout
    - automatically adapt its layout for viewing on different sized devices

## Layout

<img src="img/Fluid.png" style='max-width: 100%;max-height:90%'>
<img src="img/Responsive-Layout.png" style='max-width: 140%;max-height:60%'>
[Responsive Layout](http://goo.gl/x7fh2U)

## Useful Layout {.flexbox .vcenter}

<img src="img/Useful-Layout.png" style='max-width: 100%;max-height: 110%'>

## Navlist with ggplot2

<div class="code_block">  

```{r eval=FALSE}
runApp("apps/barplot")
##########
# ui.R   #
##########
library(shiny)
library(ggplot2)
library(dplyr)
 
shinyUI(fluidPage(
  titlePanel("Navlist panel example"),
  
  navlistPanel("header",
               selectInput('cut', 'cut', levels(diamonds$cut)), #字串可以用unique
               tabPanel("First",plotOutput('plot1')
               ),
               tabPanel("Second",
                        dataTableOutput(outputId="table")
               )
  )
))
############
# server.R #
############
library(shiny)
library(ggplot2)
library(dplyr)

shinyServer(function(input, output, session) {
   
    selectedData <- reactive({
      filter(diamonds,cut == input$cut)
    })
    output$plot1 <- renderPlot({
      bike.3p <- ggplot(data = selectedData(), 
                        aes(x = reorder(clarity, -price), y = price, colour = clarity, fill = clarity)) 
      bike.3p + geom_bar(stat="identity", width=0.5) + coord_flip()
      # geom_text can't using chinese text
      })
    output$table <- renderDataTable(selectedData())  
   
})
```

</div>

## Reactivity

<div class="notes">
This is my *note*.

- It can contain markdown
- like this list

</div>



## Slide with Interactive Plot

```{r, echo=FALSE}
inputPanel(
  selectInput("n_breaks", label = "Number of bins:",
              choices = c(10, 20, 35, 50), selected = 20),
  
  sliderInput("bw_adjust", label = "Bandwidth adjustment:",
              min = 0.2, max = 2, value = 1, step = 0.2)
)

renderPlot({
  hist(faithful$eruptions, probability = TRUE, breaks = as.numeric(input$n_breaks),
       xlab = "Duration (minutes)", main = "Geyser eruption duration")
  
  dens <- density(faithful$eruptions, adjust = input$bw_adjust)
  lines(dens, col = "blue")
})
```



# 其他整合應用

## ggvis

- 2014年中才放在CRAN的套件，持續成長中
- 使用pipe，語法類似plot
- 部分功能如tooltip需搭配shiny server才能使用
- SVG

```{r message=FALSE, echo=TRUE, warning=FALSE}
library(knitr)
library(ggvis)
out = mtcars %>%
    ggvis(x = ~wt, y = ~mpg) %>%
    layer_smooths(se=TRUE, opacity := 0.5, opacity.hover := 0.75) %>% 
    layer_points(fill = ~factor(cyl), size := 50, size.hover := 200) %>%
    set_options(hover_duration = 250) 
```

## ggvis

```{r message=FALSE, echo=FALSE, fig.height=5, fig.width=8}
out
```


