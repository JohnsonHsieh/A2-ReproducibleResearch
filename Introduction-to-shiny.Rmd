---
title: "Introduction to Shiny"
author: "George & Wush"
date: '`r Sys.Date()`'
output:
  ioslides_presentation:
    css: css/dsp.css
    # logo: assets/img/Taiwan-R-logo.png
    widescreen: yes
subtitle: shiny
runtime: shiny
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(comment="", message=FALSE, warning=FALSE)
library(knitr)
library(shiny)
library(rmarkdown)
library(ggplot2)
library(ggvis)
```

# 傢俬準備好

<img src="img/dsp-page.png" style="display:none"/>
<img src="img/dsp-front-cover.png" style="display:none"/>

## 環境安裝 {.flexbox .vcenter}

R 套件安裝
```{r Surround, eval=FALSE}
install.packages(c("dplyr","ggplot2","shiny","devtools"))
devtools::install_github('rstudio/shinyapps')
```
```{r echo=FALSE,eval=FALSE}
sessionInfo()
```

# shiny shiny little star

## 甚麼是shiny ?

<div class="columns-2">

- 一個基於R 語言的網頁應用框架
    - 可以用R 快速製作網頁應用
    - 利用近代網頁技術製作動態網頁
    - 分析結果「會動了」
- 由 RStudio 於 2012-11 年正式提出Beta版
- 目前於 2015-05 釋出 v0.11

```{r shiny-example, echo = FALSE}
inputPanel(
  selectInput("n_breaks", label = "Number of bins:",
              choices = c(10, 20, 35, 50), selected = 20)
)

renderPlot({
  hist(faithful$eruptions, probability = TRUE, breaks = as.numeric(input$n_breaks),
       xlab = "Duration (minutes)", main = "Geyser eruption duration")
  
  dens <- density(faithful$eruptions, adjust = 1)
  lines(dens, col = "blue")
})
```

</div>

## 學Shiny的好處是？

<div class="columns-2">
- 目前R中互動式分析報表最簡單的工具
    - 需要理解網頁應用的運作原理
    - **不需要**理解撰寫網頁應用工具（HTML、CSS和Javascript)，但是若想要擴充Shiny，則需要會這些工具
    - **不需要**改寫已經用R 撰寫的分析流程，但是若希望能提供流暢的使用者體驗，則需要適度的優化
- 可以和現代的Javascript視覺化函式庫做整合
    - [Introducing ggvis](http://blog.rstudio.org/2014/06/23/introducing-ggvis/)
    - [htmlwidgets: JavaScript data visualization for R](http://blog.rstudio.org/2014/12/18/htmlwidgets-javascript-data-visualization-for-r/)

```{r ggvis-example, echo = FALSE}
bootstrapPage(
  ggvisOutput("p"),
  uiOutput("p_ui")
)

mtcars %>%
  ggvis(~wt, ~mpg) %>%
  layer_points() %>%
  layer_smooths(span = input_slider(0, 1)) %>%
  bind_shiny("p", "p_ui")
```
</div>

## 網頁應用的運作原理 {.flexbox .vcenter}

- 客戶端：
    - 瀏覽器進行畫面的呈現
    - 瀏覽器和使用者進行互動
        - 依據互動的過程，瀏覽器隨時會和伺服器交換資料
            - 瀏覽器發出*Request*
            - 伺服器回傳*Response*
- 伺服器端：
    - 伺服器提供畫面的規格給瀏覽器
    - 伺服器再依據瀏覽器提供的資訊，回傳使用者需要的資料

## Shiny的運作原理

- 基本架構  
    - `ui.R`: 客戶端，負責前端使用者介面的呈現 
    - `server.R`: 伺服器端，負責後端資料處理與計算

<div class="columns-2">
  ![Image](img/interactive-1.png)

  ![Image](img/interactive-2.png)
</div>

## Shiny - 客戶端輸入：`ui.R`

- shiny 會將 `ui.R`的R 物件轉換為HTML、CSS和Javascript，透過瀏覽器呈現
- 透過Javascript，瀏覽器會將使用者的動作轉換為Request發回給Server

```{r ui1, echo=TRUE}
inputPanel(
  selectInput("n_breaks", label = "Number of bins:",
              choices = c(10, 20, 35, 50), selected = 20)
)
```

```{r ui2, engine='R', results='markup', echo=FALSE}
print(inputPanel(
  selectInput("n_breaks", label = "Number of bins:",
              choices = c(10, 20, 35, 50), selected = 20)
))
```

## Shiny - 伺服器端：`server.R`

- Shiny server處理瀏覽器傳來的Request，轉化為R 中的`input`
- 我們撰寫R 函數將`input`轉換為`output`
- Shiny server再把`output`轉換為`Response`傳回瀏覽器

```{r server-demo, echo = TRUE, eval = FALSE}
function(input, output) {
  output$plot <- renderPlot({
    hist(faithful$eruptions, probability = TRUE, breaks = as.numeric(input$n_breaks),
         xlab = "Duration (minutes)", main = "Geyser eruption duration")
    
    dens <- density(faithful$eruptions, adjust = 1)
    lines(dens, col = "blue")
  })
}
```

## Shiny - 客戶端輸出：`ui.R`

- 透過Javascript，瀏覽器會將Server回傳的`Response`呈現在瀏覽器上

```{r ui3, echo = TRUE, eval = TRUE, results='markup'}
print(plotOutput("plot"))
```

```{r s2, echo = FALSE}
inputPanel(
  selectInput("n_breaks2", label = "Number of bins:",
              choices = c(10, 20, 35, 50), selected = 20)
)

renderPlot({
  hist(faithful$eruptions, probability = TRUE, breaks = as.numeric(input$n_breaks2),
       xlab = "Duration (minutes)", main = "Geyser eruption duration")
  
  dens <- density(faithful$eruptions, adjust = 1)
  lines(dens, col = "blue")
})
```

## `server.R`

- Environment Variable  
    - 最外層 Run once: 讀套件、data  
- `shinyServer()`
    - 第一層 Function(), Run once per user
        - input list, output list, session
        - session: (補充說明?)
    - 第二層 Render Function, Run often
        - 建立輸出元件

# Hello shiny

## 如何執行 shiny apps

學習shiny，先從範例模仿  

1. 內建範例   
    ```{r eval=FALSE}
library(shiny)
runExample("01_hello")
```
2. 從Rstudio建立shiny apps: 
    + step1 Create Project   
    + step2 選 Shiny Web Application   
    + step3 檔案目錄代表app名稱    
3. 已經建立好的apps(即目錄名稱): `runApp(app_name)`  

## 我們來看看預設的`ui.R`

- `library(shiny)`載入shiny套件
- `shinyUI`：它之中的物件都是shiny UI物件
- `fluidPage`：整個瀏覽器頁面的容器
- `titlePanel`、`sidebarPanel`和`mainPanel`

```{r ui-R, echo=TRUE, eval = FALSE}
library(shiny)
shinyUI(fluidPage(
  titlePanel(title="Hello Shiny")
  sidebarPanel(
    sliderInput(inputId="bins",
                 label="Number of bins:",
                 min = 1,max = 50,value = 30))
  mainPanel(plotOutput(outputId="distPlot"))
))
```

## 程式碼的物件如何呈現於瀏覽器中?

<div class="columns-2">
  <img src="img/ui.R-new1.jpg" style='max-width: 100%;max-height:100%'>

  <img src="img/ui.R-new2.jpg" style='max-width: 100%;max-height:100%'>
</div>

## shiny UI物件的結構

- shiny UI物件會轉換為HTML，而HTML是一個結構化語言
- shiny UI物件的結構對應到HTML的結構
```{r ui-R-structure, echo = TRUE, results='markup'}
print(fluidPage())
print(titlePanel(title = "Test Title"))
print(fluidPage(titlePanel(title = "Test Title")))
```

## shiny UI物件的結構

- 每個shiny UI的物件，是以一對`(`和`)`為單位
```{r ui-tree1, echo = TRUE, eval = FALSE, results='markup'}
print(fluidPage(titlePanel(title = "Test Title")))
```

- `titlePanel(title = "Test Title")`
- `fluidPage(titlePanel(...))`

## shiny UI物件的結構

- shiny UI物件的結構，可以轉換為一個樹狀結構
```{r ui-tree1-2, echo = TRUE, eval = FALSE, results='markup'}
print(fluidPage(titlePanel(title = "Test Title")))
```

```
fluidPage <-- titlePanel
```

## shiny物件的結構

### 小挑戰

請問預設ui.R中的結構為何?

```{r ui-tree2, echo = TRUE, eval = FALSE}
fluidPage(
  titlePanel(...)
  sidebarPanel(sliderInput(...))
  mainPanel(plotOutput(...))
)
```

```
fluidPage <--- titlePanel
            |- sidebarPanel <--- sliderInput
            |- mainPanel <--- plotOutput
```

## shiny UI物件的參數

- shiny UI物件的參數會影響到產生的HTML的語法，進而在瀏覽器造成不同的呈現結果
```{r ui-param, echo = TRUE, results='markup'}
titlePanel(title = "Test Title 1")
titlePanel(title = "Test Title 2")
```

## Hello Shiny的`ui.R`中shiny物件的功能與常用參數

- `titlePanel` 產生標題
    - `title`：頁面的標題
- `sidebarPanel` 頁面左區塊的容器
    - 參數是其他shiny UI物件
- `sliderInput` 使用者可以拉動的Bar
    - `inputId`：產生的Request物件的欄位（和server.R有關）
    - `label`：顯示在瀏覽器上的說明文字
    - `min`：Bar的最小值
    - `max`：Bar的最大值
    - `value`：預設值
    - `step`：使用者滑動Bar的最小單位（不給的話，Shiny會自動決定）
    
## Hello Shiny的`ui.R`中shiny物件的功能與常用參數

- `mainPanel` 頁面右方區塊的容器
    - 參數是其他shiny UI物件
- `plotOutput` 呈現來自伺服器的圖形輸出
    - `outputId`：對應的Response物件的欄位（和server.R有關）
    - `width`：寬度
    - `height`：高度

## 小挑戰 -- 更改title

- 依照講師前述的操作，建立一個Shiny App，名叫：DSPShinyCourse
- 點下Run App來瀏覽Shiny Application
- 關閉產生的視窗
- 修改`ui.R`中`titlePanel`的值
- 點下Run App來看title是否有更動

## 小挑戰 -- 更改結構

- 繼續使用DSPShinyCourse
- 修改`ui.R`
    - 把整段`sliderInput`的程式碼從`sidebarPanel`剪下貼上到`mainPanel`之中
    - 點下Run App
- 如果對R 語言不是很熟悉的同學，可能會遇到以下錯誤：
```
ERROR: /home/wush/Project/DSPShinyCourse/ui.R:28:7: unexpected symbol
27:                   value = 30)
28:       plotOutput
```
- 觀察`sliderInput`位置的改變
    - 理解兩種容器：`sidebarPanel`和`mainPanel`的位置與用途

## Hello Shiny的`server.R`

## Panel to Page

<div class="code_block">  
```{r echo=FALSE}
shinyApp(
  ui=fluidPage(
    titlePanel("Hello Shiny!"),
    sidebarLayout(
      sidebarPanel(
        sliderInput("bins","Number of bins:",
                    min = 1,max = 50,value = 30)
      ),
      mainPanel(
        plotOutput("distPlot")
      )
    )
  ),
  server=function(input, output) {
    output$distPlot <- renderPlot({
      x    <- faithful[, 2]  # Old Faithful Geyser data
      bins <- seq(min(x), max(x), length.out = input$bins + 1)
      hist(x, breaks = bins, col = 'darkgray', border = 'white')
    })
  },
  options = list(height = 500)
)
```

```{r eval=FALSE}
##############################
### Hello Shiny - ui.R #######
##############################
library(shiny)

# Define UI for application that draws a histogram
shinyUI(fluidPage(

  # Application title
  titlePanel("Hello Shiny!"),

  # Sidebar with a slider input for the number of bins
  sidebarLayout(
    sidebarPanel(
      sliderInput("bins",
                  "Number of bins:",
                  min = 1,
                  max = 50,
                  value = 30)
    ),

    # Show a plot of the generated distribution
    mainPanel(
      plotOutput("distPlot")
    )
  )
))
##############################
### Hello Shiny - server.R ###
##############################
library(shiny)

# Define server logic required to draw a histogram
shinyServer(function(input, output) {

  # Expression that generates a histogram. The expression is
  # wrapped in a call to renderPlot to indicate that:
  #
  #  1) It is "reactive" and therefore should be automatically
  #     re-executed when inputs change
  #  2) Its output type is a plot

  output$distPlot <- renderPlot({
    x    <- faithful[, 2]  # Old Faithful Geyser data
    bins <- seq(min(x), max(x), length.out = input$bins + 1)

    # draw the histogram with the specified number of bins
    hist(x, breaks = bins, col = 'darkgray', border = 'white')
  })

})
```
</div>


## 小挑戰1:自行撰寫app

將Hello Shiny 改為自己的App，將資料改為用`ubike`並計算最大空位數(``)的直方圖。  

> ~/myapp    \   
> -- ui.R       <br />
> -- server.R  \  

`HINT`   
- 確認工作環境 `getwd()`，有需要則設定工作環境`setwd(choose.dir())`  
- 建立`myapp`目錄  
- 利用上述 **Hello Shiny** 程式碼分別建立**ui.R**,**server.R**於**myapp**目錄下  
- 將 `faithful[, 2]` 換成 `ubike[,'max.bemp']`
- 建立完自行執行 `runApp(myApp)`  

## Answer

<div class="code_block">  
```{r ubike_hist}
load("data/ubikeweather_big5.rda")
#titlePanel(title="Hello Shiny")
sidebarPanel(
  sliderInput(inputId="bins",
               label="Number of bins:",
               min = 1,max = 50,value = 30))
mainPanel(  plotOutput(outputId="distPlot"))
output$distPlot <- renderPlot({
  x    <- ubike[, 'max.bemp']  # Old Faithful Geyser data
  bins <- seq(min(x), max(x), length.out = input$bins + 1)
  # draw the histogram with the specified number of bins
  hist(x, breaks = bins, col = 'darkgray', border = 'white')
})
```
</div>







## Widgets 工具大彙整

- [source code](https://dl.dropboxusercontent.com/u/68133220/DSP/app_widgets.rar)
```{r, eval=FALSE}
runApp("apps/widgets",display.mode="showcase")
```

## Learn Widgets

```{r, eval=FALSE}
runApp("apps/widgets-examples",display.mode="showcase")
##############################
### data Types - ui.R ########
##############################
library(shiny)  

shinyUI(pageWithSidebar( 
  
  headerPanel("Widget values and data types"), 
  
  sidebarPanel(
    
    checkboxGroupInput(inputId = "checkGroup",
                       label = "1. checkboxGroupInput",
                       choices = list("Ice cream" = "IC", "Trifle" = "Trifle",
                                      "Pistachios" = "Pist")),
    
    checkboxInput(inputId = "boxInput",
                  label = "2. checkboxInput"),
    
    dateInput(inputId = "theDate",
              label = "3. dateInput"),
    
    dateRangeInput(inputId = "dateRange",
                   label = "4. dateRangeInput"),
    
    numericInput(inputId = "pickNumber",
                 label = "5. numericInput",
                 min = 1, max = 10, value = 1),
    
    radioButtons(inputId = "pickRadio",
                 label = "6. radioButtons",
                 choices = list("Taxi" = "Taxi", "Take a walk" = "Walk")),
    
    selectInput(inputId = "comboBox",
                label = "7. selectInput",
                choices = list("News" = "News", "Situation comedy" = "Sitcom", "Film" = "Film")),
    
    sliderInput(inputId = "slider",
                label = "8. sliderInput",
                min = 1, max = 10, value = 7, step = 1),
    
    textInput(inputId = "comment",
              label = "9. textInput",
              value = "")
    
  ),
  
  mainPanel( 
    h3("Output and data type"),
    tableOutput("textDisplay")
  )
))

##########################################
##### data types and values - server.R ###
##########################################
library(shiny)
 
shinyServer(function(input, output) { 
  
  output$textDisplay <- renderTable({ 
                                     
    getMat = matrix(c(paste(input$checkGroup, collapse=','), class(input$checkGroup),
                      input$boxInput, class(input$boxInput),
                      as.character(as.Date(input$theDate, origin = "1970-01-01")), class(input$theDate),
                      paste(as.character(as.Date(input$dateRange[1], origin = "1970-01-01")),
                            as.character(as.Date(input$dateRange[2], origin = "1970-01-01")), collapse = ','),
                            class(input$dateRange),
                      input$pickNumber, class(input$pickNumber),
                      input$pickRadio, class(input$pickRadio),
                      input$comboBox, class(input$comboBox),
                      input$slider, class(input$slider),
                      input$comment, class(input$comment)
                      ), ncol=2, byrow = TRUE)
 
    colnames(getMat) = c("Value", "Class")
    
    getMat
 
  })
})
```

## 小挑戰2: (upload widgets)

# I want learn more

## Layout

通常指網頁版面，頁面的形式，佈局

- Sidebar Layouts(Simple default layout)
- Grid Layouts  
    - Custom application layouts: fluid & fixed
    - `fluidPage(fluidRow(column()))`
        - a flexibly sub-dividable 12-column grid for layout
- Segmenting Layouts
    - `navbarPage(tabPanel(), navbarMenu())`
    - `tabsetPanel(tabPanel()), navlistPanel(tabPanel())`
- Responsive Layout
    - automatically adapt its layout for viewing on different sized devices

## Layout

<img src="img/Fluid.png" style='max-width: 100%;max-height:90%'>
<img src="img/Responsive-Layout.png" style='max-width: 140%;max-height:60%'>
[Responsive Layout](http://goo.gl/x7fh2U)

## Useful Layout {.flexbox .vcenter}

<img src="img/Useful-Layout.png" style='max-width: 100%;max-height: 110%'>

## navbarPage & navlistPanel

```{r navlist, echo=FALSE}
shinyApp(
  ui = navbarPage("NavbarPage Example",
    tabPanel("Tab1",
      titlePanel("Navlist Panel Example"),
      selectInput(inputId='cut', label='cut', levels(diamonds$cut)), #字串可以用unique
      navlistPanel("Header Name",
               tabPanel("barplot",plotOutput('plot1')),
               tabPanel("dataTable",dataTableOutput(outputId="table"))
      )#navlistPanel
    )#tabPanel:Tab1
  ), #shinyUI,navarPage
  server = function(input, output, session) {
    selectedData <- reactive({
      filter(diamonds,cut == input$cut)
    })
    output$plot1 <- renderPlot({
      diamond.p <- ggplot(data = selectedData(), 
                    aes(x = reorder(clarity, -price), y = price, colour = clarity, fill = clarity)) 
      diamond.p + geom_bar(stat="identity", width=0.5) + coord_flip()
      # geom_text can't using chinese text
    })
    output$table <- renderDataTable(selectedData())
  },
  options = list(height = 500)
)
```

</div>

## 小挑戰-4 (with code example)

Q: 練習將barplot與dataTable製作成同個頁面的navlistpanel
<div class="code_block">  
```{r eval=FALSE}
runApp("apps/barplot")
##########
# ui.R   #
##########
library(shiny)
library(ggplot2)
library(dplyr)

## 這裡可以讀資料(實際上不建議這樣寫)
## the working directory is under your apps_names directory
# print(getwd())
# load("../../data/ubikeweather_big5.rda")

shinyUI(navbarPage("",
  titlePanel("Navlist panel example"),
  
  navlistPanel("header",
               selectInput('cut', 'cut', levels(diamonds$cut)), #字串可以用unique
               tabPanel("First",plotOutput('plot1')
               ),
               tabPanel("Second",
                        dataTableOutput(outputId="table")
               )
  )
))
############
# server.R #
############
library(shiny)
library(ggplot2)
library(dplyr)

## 這裡可以讀資料(實際上不建議這樣寫)
## the working directory is under your apps_names directory
# print(getwd())
# load("../../data/ubikeweather_big5.rda")

shinyServer(function(input, output, session) {
   
    selectedData <- reactive({
      filter(diamonds,cut == input$cut)
    })
    output$plot1 <- renderPlot({
      bike.3p <- ggplot(data = selectedData(), 
                        aes(x = reorder(clarity, -price), y = price, colour = clarity, fill = clarity)) 
      bike.3p + geom_bar(stat="identity", width=0.5) + coord_flip()
      # geom_text can't using chinese text
      })
    output$table <- renderDataTable(selectedData())  
   
})
```

</div>


## Reactivity

<div class="notes">
This is my *note*.

- It can contain markdown
- like this list

</div>


# 其他整合應用

## ggvis

- 2014年中才放在CRAN的套件，持續成長中
- 使用pipe，語法類似plot
- 部分功能如tooltip需搭配shiny server才能使用
- SVG

```{r message=FALSE, echo=TRUE, warning=FALSE}
library(knitr)
library(ggvis)
out = mtcars %>%
    ggvis(x = ~wt, y = ~mpg) %>%
    layer_smooths(se=TRUE, opacity := 0.5, opacity.hover := 0.75) %>% 
    layer_points(fill = ~factor(cyl), size := 50, size.hover := 200) %>%
    set_options(hover_duration = 250) 
```

## ggvis

```{r message=FALSE, echo=FALSE, fig.height=5, fig.width=8}
out
```

# 期末成發

## [shinyapps(v0.3.64)](https://www.shinyapps.io/)

- [Getting started with shinyapps.io](http://shiny.rstudio.com/articles/shinyapps.html)
- Platform as a service for hosting shiny web apps
    1. Windows users: Rtools  
    2. Mac users: XCode Command Line Tools  
    3. Linux users: GCC  
- The latest version of the [shinyapps](https://github.com/rstudio/shinyapps) R package
- Application
    - Application loggint: `shinyapps::showLogs()`
    - Configuring applications: `shinyapps::configureApp(APPNAME,size="small")`
    - Application authentication(目前只有付費才有此功能)
    - Terminate an app: `terminateApp("<your app's name>")`
